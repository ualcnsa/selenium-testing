= Tests de Selenium en Jenkins

////
COLOCA A CONTINUACIÓN LOS OBJETIVOS
////
.Objetivos 
====
* Ejecutar los test de Selenium JUnit Webdriver en Jenkins utilizando el navegador en modo _headless_.
* Diseñar un pipeline con fases en paralelo para la ejecución de los test en cada navegador.
====

.Realización y entrega
****
La realización de estas actividades se realizará en equipo. La entrega será mediante el envío de un informe y el acceso al profesor a los servicios configurados, para la revisión y evaluación de los mismos. 
****


== Selenium WebDriver y Jenkins

link:selenium-webdriver.html[Selenium WebDriver] permite ejecutar los tests de Selenium como tests de JUnit, permitiendo así su ejecución en Eclipse y Jenkins. 

La ejecución de los tests de Selenium en Jenkins debe hacerse en modo _headless_ ya que la máquina Jenkins no tiene instalada una interfaz gráfica, más comúnmente conocida como X o X11 en Linux. Utilizaremos el driver _RemoteWebDriver_ para ejecutar los tests dentro de un contenedor Docker con el navegador en modo _headless_.

=== Modificación de los tests para utilizar RemoteWebDriver

Para poder ejecutar los tests de Selenium en Jenkins, debemos modificar el código fuente de los tests para que utilicen el driver _RemoteWebDriver_ en lugar del driver _FirefoxDriver_ o _ChromeDriver_.

[source,java]
----
  @Before
  public void setUp() throws Exception {
    ...
    FirefoxOptions options = new FirefoxOptions();
    options.setHeadless(true);
    driver = new RemoteWebDriver(new URL("http://localhost:4444/wd/hub"), options);
    ...
  }
----

[WARNING]
Utilizamos la url `http://localhost:4444/wd/hub` para indicar que el driver está en el contenedor Docker que ejecutamos en Jenkins. Si tuvieramos el driver en otra máquina, deberíamos indicar la url de la máquina donde está el driver.

=== Creación del pipeline en Jenkins

. Crea en Jenkins un nuevo proyecto pipeline. Incluye la fase (_stage_) con nombre `Firefox tests`.
. Lanza un contenedor Docker con la imagen `selenium/standalone-firefox` y ejecuta los tests de Selenium en modo _headless_. Para ello, utiliza el bloque `sh` de Jenkins, y ejecuta el siguiente comando: 

    docker run -d -p 4444:4444 -v /dev/shm:/dev/shm -v /var/run/docker.sock:/var/run/docker.sock selenium/standalone-firefox:4.8.1-20230306

. Invoca a Maven para ejecutar los tests de Selenium. Para ello, utiliza el bloque `sh` de Jenkins, y ejecuta el siguiente comando:

    mvn test

El pipeline tendrá esta forma: 


[source,groovy]
.Jenkinsfile
----
pipeline {
    agent any
    environment {
        DRIVERS_LOC = "$JENKINS_HOME/selenium-drivers/"
    }
    tools {
        // Usa aquí el nombre de tu instalación de Maven en Jenkins Tools
        maven "Default maven"
    }
    stages {
        stage('Git clone') {
            steps{
                // Update the URL to your repo
                git 'https://github.com/tu-usuario/tu-repo-selenium.git'
            }
        }
        stage('Firefox tests') {
            steps {
                // Run Maven on xvfb environment display.
                // Update the path/to/your/pom.xml as necessary
                sh 'docker run -d -p 4444:4444 -v /dev/shm:/dev/shm -v /var/run/docker.sock:/var/run/docker.sock selenium/standalone-firefox:4.8.1-20230306'
                sh 'mvn test' 

            }
            post {
                // If Maven was able to run the tests, even if some of the test
                // failed, record the test results
                success {
                    junit '**/target/surefire-reports/TEST-*.xml'
                }
            }
        }
    }
}

----



[WARNING]
====
Comprueba que en el código de los tests Selenium en JUnit estás usando `RemoteWebDriver`, y modo _headless_
====

[start=3]
. Publica la gráfica de los tests en un bloque `post` del pipeline.

.Pipeline con la fase Firefox Test
image::jenkins-webdriver-pipeline-firefox-ok.png[role="thumb", align="center"]

=== A partir de aquí es optativo

[start=4]
. Para probar la ejecución con Chrome, debes utilizar la imagen `selenium/standalone-chrome` en lugar de la imagen `selenium/standalone-firefox`.

. Habrás implementado dos alternativas de ejecución en Jenkins de los test de Selenium en modo _headless_.
Sin embargo, el diseño de clases JUnit y uso de los distintos drivers tiene varias desventajas: 
- Para ejecutar con un navegador u otro tenemos que tocar el código fuente y modificar el driver "a mano"
- Esto implica que no se puede lanzar la ejecución en los dos navegadores en el mismo pipeline: o ejecutamos con Firefox o ejecutamos con Chrome. 

Lo ideal es poder diseñar el pipeline para lanzar en paralelo la ejecución en estos dos, o cuantos  navegadores sean necesarios, tal y como se muestra en la siguiente imagen: 

.Pipeline con ejecución de varios navegadores en paralelo
image::jenkins-blueocean-parallel-browser-testing.png[role="thumb", align="center"]

[IMPORTANT]
====
*EJERCICIOS (Optativos)* 

. Rediseña las clases JUnit con los test de Selenium para poder lanzar los tests bien con Firefox o bien con en Chrome, sin tener que modificar el código fuente, es decir, sin tener que cambiar el driver "a mano". Para ello revisa el ejemplo https://github.com/ualhmis/seleniumWebDriverJUnit/tree/junit5/seleniumHMIS21[seleniumHMIS21] en su rama master (JUnit 4), y en la rama junit5. 

. Crea dos fases en el pipeline, una para Firefox y otra para Chrome, y configura el pipeline para que se ejecuten en paralelo, usando el bloque https://www.jenkins.io/blog/2017/09/25/declarative-1/[`parallel`] (Más info: https://www.jenkins.io/doc/book/pipeline/syntax/#parallel[Jenkins Pipeline Syntax])
====


== Más info

- https://github.com/shailendravaichalkar/Selenium-Maven-Template

- Mas información sobre https://www.selenium.dev/maven[Maven con Selenium].

- https://www.browserstack.com/guide/selenium-with-java-for-automated-test[Buenas prácticas]: Selenium con Java


